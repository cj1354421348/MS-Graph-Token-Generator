# MS Graph Token Manager (Microsoft Graph ä»¤ç‰Œç®¡ç†å™¨)

è¿™æ˜¯ä¸€ä¸ªç”¨äºç”Ÿæˆã€éªŒè¯å’Œè‡ªåŠ¨ç»­æœŸ Microsoft Graph Refresh Token çš„å·¥å…·å¥—ä»¶ã€‚
ç‰¹åˆ«é€‚ç”¨äºéœ€è¦é•¿æœŸè¿è¡Œçš„è„šæœ¬æˆ–åå°æœåŠ¡ (å¦‚ Outlook é‚®ä»¶ç®¡ç†)ï¼Œæ”¯æŒ **Public Client (æ¡Œé¢/æ— å¯†ç )** æ¨¡å¼ï¼Œè§£å†³ 90 å¤©æœ‰æ•ˆæœŸé—®é¢˜ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
ç¡®ä¿å·²å®‰è£… Pythonï¼Œç„¶åå®‰è£…ä¾èµ–ï¼š
```bash
pip install -r requirements.txt
```

### 2. æ ¸å¿ƒé…ç½® (`.env`)
å¤åˆ¶ `.env.example` ä¸º `.env`ï¼Œå¹¶ä¿®æ”¹ä»¥ä¸‹å…³é”®é¡¹ï¼š

```properties
# ä½ çš„ Azure åº”ç”¨ ID
CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# ã€å…³é”®ã€‘æ¡Œé¢/è„šæœ¬åº”ç”¨å¿…é¡»ç•™ç©ºæˆ–åˆ é™¤ Client Secretï¼
# CLIENT_SECRET=

# å›è°ƒåœ°å€ (å¿…é¡»ä¸ Azure é—¨æˆ·ä¸€è‡´)
# Azure é—¨æˆ· -> èº«ä»½éªŒè¯ -> ç§»åŠ¨å’Œæ¡Œé¢åº”ç”¨ç¨‹åº -> æ·»åŠ  URI: http://localhost
REDIRECT_URI=http://localhost:5000

# æƒé™èŒƒå›´ (æ”¶å‘é‚®ä»¶æ¨èé…ç½®)
SCOPE=offline_access https://outlook.office.com/IMAP.AccessAsUser.All https://outlook.office.com/SMTP.Send
```

---

## ğŸ› ï¸ å·¥å…·ä½¿ç”¨æŒ‡å—

### 1. è·å–æ–° Token (åˆæ¬¡æˆ–å¤±æ•ˆæ—¶)
å½“ä½ è¦æ·»åŠ æ–°è´¦å·ï¼Œæˆ–è€…æŸä¸ªè´¦å· Token å¤±æ•ˆæ—¶ä½¿ç”¨ã€‚

è¿è¡Œï¼š
```bash
python main.py
```
1. æµè§ˆå™¨æ‰“å¼€ `http://localhost:5000`ã€‚
2. ç‚¹å‡»ç™»å½•ï¼Œæˆæƒå¾®è½¯è´¦å·ã€‚
3. æˆåŠŸåï¼Œé¡µé¢ä¼šæ˜¾ç¤º **Client ID** å’Œ **Refresh Token**ã€‚
4. å°†è¿™äº›ä¿¡æ¯å¡«å…¥ä½ çš„ `accounts.json` æ–‡ä»¶ä¸­ã€‚

---

### 2. è‡ªåŠ¨ç»­æœŸ/ä¿æ´» (æ ¸å¿ƒåŠŸèƒ½)
å¾®è½¯ Token æœ‰æ•ˆæœŸä¸º 90 å¤©ã€‚ä¸ºäº†é¿å…è¿‡æœŸï¼Œè¯·**å®šæœŸè¿è¡Œ**æ­¤å·¥å…·ã€‚

è¿è¡Œï¼š
```bash
python token_refresher.py
```
**åŠŸèƒ½ï¼š**
- è‡ªåŠ¨è¯»å– `accounts.json` ä¸­çš„æ‰€æœ‰è´¦æˆ·ã€‚
- é€ä¸ªå°è¯•ç”¨æ—§ Token æ¢å–æ–° Tokenã€‚
- **æˆåŠŸ**ï¼šè‡ªåŠ¨æ›´æ–° json æ–‡ä»¶é‡Œçš„ `refresh_token`ï¼Œå®ç°â€œæ— é™ç»­æ¯â€ã€‚
- **å¤±è´¥**ï¼šæç¤ºé”™è¯¯ (é€šå¸¸æ„å‘³ç€éœ€è¦ç”¨æ­¥éª¤ 1 é‡æ–°äººå·¥ç™»å½•)ã€‚

**å»ºè®®**ï¼šåŠ å…¥ç³»ç»Ÿè®¡åˆ’ä»»åŠ¡ (Windows Task Scheduler)ï¼Œæ¯å‘¨è¿è¡Œä¸€æ¬¡ã€‚

---

### 3. Token è¯Šæ–­
å¦‚æœä½ ä¸ç¡®å®šæŸä¸ª Token æ˜¯å¦è¿˜èƒ½ç”¨ï¼š

è¿è¡Œï¼š
```bash
python verify_token.py
```
ç²˜è´´ä½ çš„ Tokenï¼Œå®ƒä¼šå‘Šè¯‰ä½ æ˜¯å¦å­˜æ´»ï¼Œæˆ–è€…å…·ä½“çš„æ­»äº¡åŸå› ã€‚

---

## ğŸ“… è‡ªåŠ¨è°ƒåº¦ä¸é€šçŸ¥ (Deployment)

æ¨èä½¿ç”¨ Docker Compose éƒ¨ç½²ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæ™ºèƒ½è°ƒåº¦å™¨ (`scheduler.py`)ã€‚

### æ ¸å¿ƒç‰¹æ€§
1.  **è‡ªåŠ¨è½®è¯¢**: æ¯ 7 å¤©è‡ªåŠ¨å”¤é†’æ‰§è¡Œä¸€æ¬¡ã€‚
2.  **å®‰å…¨éš”ç¦»**: ä½¿ç”¨å­è¿›ç¨‹è¿è¡Œä¸šåŠ¡è„šæœ¬ï¼Œäº’ä¸å½±å“ã€‚
3.  **æ•°æ®åº“åŒæ­¥**: å°†æœ€æ–°çš„ Token åŒæ­¥åˆ° PostgreSQL (éœ€é…ç½® `DB_URL`)ã€‚
4.  **æ¶ˆæ¯æ¨é€**: æ‰§è¡Œç»“æŸåé€šè¿‡ Notify Hub å‘é€æ±‡æ€»æŠ¥å‘Š (éœ€é…ç½® `NOTIFY_API_URL`)ã€‚

### å¯åŠ¨å‘½ä»¤
```bash
docker-compose up -d --build
```
æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
docker-compose logs -f
```

**å·¥ä½œæµç¤ºæ„å›¾**:
`Scheduler` -> `Token Refresher` -> `DB Sync` -> `Notify (Consolidated Report)`

---

### 4. è´¦æˆ·æ–‡ä»¶ç¤ºä¾‹ (accounts.json)
`token_refresher.py` ä¾èµ–æ­¤æ–‡ä»¶æ¥å­˜å‚¨å’Œæ›´æ–° Tokenã€‚
æ ¼å¼å¦‚ä¸‹ï¼ˆJson å­—å…¸ï¼ŒKey æ˜¯é‚®ç®±ï¼ŒValue æ˜¯è¯¦ç»†ä¿¡æ¯ï¼‰ï¼š

```json
{
  "example@outlook.com": {
    "refresh_token": "M.C542_SN1.0.U.-Ckx...",
    "client_id": "ä½ çš„_CLIENT_ID"
  },
  "another_user@outlook.com": {
    "refresh_token": "M.C538_BAY.0.U.-Ci1...",
    "client_id": "å¦ä¸€ä¸ª_CLIENT_ID"
  }
}
```
**æ³¨æ„ï¼š** `refresh_token` å’Œ `client_id` æ˜¯å¿…é¡»çš„å­—æ®µã€‚

---

## ğŸ“‚ æ–‡ä»¶è¯´æ˜
- `accounts.json`: ä½ çš„è´¦æˆ·æ•°æ®åº“ (å­˜å‚¨ Token çš„åœ°æ–¹)ã€‚
- `main.py`: ç½‘é¡µç‰ˆç”Ÿæˆå™¨ (äººå·¥æ“ä½œ)ã€‚
- `token_refresher.py`: æ‰¹é‡è‡ªåŠ¨ç»­æœŸè„šæœ¬ (æœºå™¨æ“ä½œ)ã€‚
- `verify_token.py`: å•ä¸ª Token æµ‹è¯•å·¥å…·ã€‚
